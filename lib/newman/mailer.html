<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>mailer.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="../newman.html">newman.rb</a>
          <a class="source" href="application.html">application.rb</a>
          <a class="source" href="controller.html">controller.rb</a>
          <a class="source" href="email_logger.html">email_logger.rb</a>
          <a class="source" href="filters.html">filters.rb</a>
          <a class="source" href="mailer.html">mailer.rb</a>
          <a class="source" href="mailing_list.html">mailing_list.rb</a>
          <a class="source" href="request_logger.html">request_logger.rb</a>
          <a class="source" href="response_logger.html">response_logger.rb</a>
          <a class="source" href="server.html">server.rb</a>
          <a class="source" href="settings.html">settings.rb</a>
          <a class="source" href="store.html">store.rb</a>
          <a class="source" href="store/recorder.html">recorder.rb</a>
          <a class="source" href="test_mailer.html">test_mailer.rb</a>
          <a class="source" href="version.html">version.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>mailer.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p><code>Newman::Mailer</code> allows you to easily receive mail via IMAP and send mail via
SMTP, and is the default mailing strategy used by <code>Newman::Server.simple</code>.
This class mostly exists to serve as an adapter that bridges the gap between
the mail gem and Newman&rsquo;s configuration system. </p>

<p><code>Newman::Mailer</code>&rsquo;s interface minimal by design so that other objects
can easily stand in for it as long as they respond to the same set of
messages. Be sure to see <code>Newman::TestMailer</code> for an example of how to build a
custom object that can be used in place of a <code>Newman::Mailer</code> object.</p>

<p><code>Newman::Mailer</code> is part of Newman&rsquo;s <strong>internal interface</strong>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">module</span> <span class="nn">Newman</span>
  <span class="k">class</span> <span class="nc">Mailer</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre>    </pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>To initialize a <code>Newman::Mailer</code> object, a settings object must be
provided, i.e:</p>

<pre><code>settings = Newman::Settings.from_file(&lsquo;config/environment.rb&rsquo;)
mailer   = Newman::Mailer.new(settings)
</code></pre>

<p>This is done automatically for you by <code>Newman::Server.simple</code>, but must be
done manually if you are creating a <code>Newman::Server</code> instance from
scratch.</p>

<p>Currently, not all of the settings supported by the mail gem are mapped by
Newman. This is by design, to limit the amount of configuration options
need to think about. However, if this is causing you a problem, 
please <a href="https://github.com/mendicant-university/newman/issues">file an issue</a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
      <span class="n">imap</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">imap</span>
      <span class="n">smtp</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">smtp</span>

      <span class="nb">self</span><span class="o">.</span><span class="n">retriever_settings</span> <span class="o">=</span> <span class="p">{</span>
         <span class="ss">:address</span>    <span class="o">=&gt;</span> <span class="n">imap</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
         <span class="ss">:user_name</span>  <span class="o">=&gt;</span> <span class="n">imap</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
         <span class="ss">:password</span>   <span class="o">=&gt;</span> <span class="n">imap</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
         <span class="ss">:enable_ssl</span> <span class="o">=&gt;</span> <span class="n">imap</span><span class="o">.</span><span class="n">ssl_enabled</span> <span class="o">||</span> <span class="kp">false</span><span class="p">,</span>
         <span class="ss">:port</span>       <span class="o">=&gt;</span> <span class="n">imap</span><span class="o">.</span><span class="n">port</span>
      <span class="p">}</span>
      
      <span class="nb">self</span><span class="o">.</span><span class="n">delivery_settings</span> <span class="o">=</span> <span class="p">{</span>
         <span class="ss">:address</span>              <span class="o">=&gt;</span> <span class="n">smtp</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
         <span class="ss">:user_name</span>            <span class="o">=&gt;</span> <span class="n">smtp</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
         <span class="ss">:password</span>             <span class="o">=&gt;</span> <span class="n">smtp</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
         <span class="ss">:authentication</span>       <span class="o">=&gt;</span> <span class="ss">:plain</span><span class="p">,</span>
         <span class="ss">:enable_starttls_auto</span> <span class="o">=&gt;</span> <span class="n">smtp</span><span class="o">.</span><span class="n">starttls_enabled</span> <span class="o">||</span> <span class="kp">false</span><span class="p">,</span>
         <span class="ss">:port</span>                 <span class="o">=&gt;</span> <span class="n">smtp</span><span class="o">.</span><span class="n">port</span>
      <span class="p">}</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>Use the <code>messages</code> method to retrieve all messages currently in the inbox
and then delete them from the server. This method returns an array of
<code>Mail::Message</code> objects if any messages were found, and returns
an empty array otherwise.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">messages</span>
      <span class="no">Mail</span><span class="o">::</span><span class="no">IMAP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">retriever_settings</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">:delete_after_find</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre>    </pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>Use the <code>new_message</code> method to construct a new <code>Mail::Message</code> object,
with the delivery settings that were set up at initialization time. 
This method passes all its arguments on to <code>Mail.new</code>, so be sure 
to refer to the <a href="http://github.com/mikel/mail">mail gem&rsquo;s documentation</a>
for details.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">new_message</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span>
      <span class="n">msg</span><span class="o">.</span><span class="n">delivery_method</span><span class="p">(</span><span class="ss">:smtp</span><span class="p">,</span> <span class="n">delivery_settings</span><span class="p">)</span>

      <span class="n">msg</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre>    </pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>Use the <code>deliver_message</code> method to construct and immediately deliver a
message using the delivery settings that were set up at initialization
time.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">deliver_message</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span>
      <span class="n">new_message</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">deliver</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kp">private</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>These accessors are private because they are an implementation detail 
and should not be depended upon. <code>Newman::Mailer</code> objects should be
treated as immutable constructs.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kp">attr_accessor</span> <span class="ss">:retriever_settings</span><span class="p">,</span> <span class="ss">:delivery_settings</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
