<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>application.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="../newman.html">newman.rb</a>
          <a class="source" href="application.html">application.rb</a>
          <a class="source" href="controller.html">controller.rb</a>
          <a class="source" href="email_logger.html">email_logger.rb</a>
          <a class="source" href="filters.html">filters.rb</a>
          <a class="source" href="mailer.html">mailer.rb</a>
          <a class="source" href="mailing_list.html">mailing_list.rb</a>
          <a class="source" href="recorder.html">recorder.rb</a>
          <a class="source" href="request_logger.html">request_logger.rb</a>
          <a class="source" href="response_logger.html">response_logger.rb</a>
          <a class="source" href="server.html">server.rb</a>
          <a class="source" href="settings.html">settings.rb</a>
          <a class="source" href="store.html">store.rb</a>
          <a class="source" href="test_mailer.html">test_mailer.rb</a>
          <a class="source" href="version.html">version.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>application.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p><code>Newman::Application</code> provides the main entry point for Newman application
developers, and exists to tie together various Newman objects in a convenient
way.</p>

<p>For an fairly complete example of a <code>Newman::Application</code> object in use, be
sure to check out <a href="https://github.com/mendicant-university/jester">Jester</a>.</p>

<p><code>Newman::Application</code> is part of Newman&rsquo;s <strong>external interface</strong></p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">module</span> <span class="nn">Newman</span> 
  <span class="k">class</span> <span class="nc">Application</span>

    <span class="kp">include</span> <span class="no">Filters</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre>    </pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>A <code>Newman::Application</code> object is a blank slate upon creation, with fields
set to hold <code>callbacks</code>, <code>matchers</code>, and <code>extensions</code>. A block may
optionally be provided, which then gets executed within the context of the
newly created <code>Newman::Application</code> instance. This is the common way of
building applications, and is demonstrated by the example below:</p>

<pre><code>ping_pong = Newman::Application.new do
  subject(&ldquo;ping&rdquo;) do
    respond(:subject =&gt; &ldquo;pong&rdquo;)
  end
end
</code></pre>

<p>Any method that can be called on a <code>Newman::Application</code> instance can be
called within the provided block, including those methods mixed in by
<code>Newman::Filters</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">callbacks</span>  <span class="o">=</span> <span class="o">[]</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">matchers</span>   <span class="o">=</span> <span class="p">{}</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">extensions</span> <span class="o">=</span> <span class="o">[]</span>

      <span class="nb">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="k">if</span> <span class="nb">block_given?</span>
    <span class="k">end</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre>    </pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p><code>Newman::Application#call</code> accepts a hash of parameters which gets used to
create a new <code>Newman::Controller</code> object. The controller is then extended
by all of the modules stored in the <code>extensions</code> field on the application
object, and is finally passed along to
<code>Newman::Application#trigger_callbacks</code>, which does the
magical work of figuring out which callbacks to run, if any.</p>

<p>This method is meant to be run by a <code>Newman::Server</code> object, and isn&rsquo;t
especially useful on its own.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="n">controller</span> <span class="o">=</span> <span class="no">Controller</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>      
      <span class="n">extensions</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">mod</span><span class="o">|</span> <span class="n">controller</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">trigger_callbacks</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre>   </pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p><code>Newman::Application#default</code> provides a way to define a default callback
to run when no other callbacks match the incoming request. For example,
you can define a callback such as the one below:</p>

<pre><code>default do
  respond(:subject =&gt; &ldquo;REQUEST NOT UNDERSTOOD&rdquo;)
end
</code></pre>

<p>Unless you are building an application that will never fail to 
match at least one of its filters, you MUST set up a default callback 
if you want to avoid a possible application error. We know this is
not exactly the most desireable behavior, and will try to fix this
in a future version of Newman.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="o">&amp;</span><span class="n">callback</span><span class="p">)</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">default_callback</span> <span class="o">=</span> <span class="n">callback</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre>    </pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p><code>Newman:::Application#use</code> stores a module to be mixed in to the
controller object created each time <code>Newman::Application#call</code>
is run. This allows an application object to provide extensions
for use within its callbacks, as in the example shown below.</p>

<pre><code>module ListLoader
  def load_list(name)
    store = Newman::Store.new(settings.application.list_db)
    Newman::MailingList.new(name, store)
  end
end

list_app = Newman::Application.new do
  use ListLoader

  match :list_id, &ldquo;[^.]+&rdquo;

  to(:tag, &ldquo;{list_id}.subscribe&rdquo;) do
    list = load_list(params[:list_id])

    if list.subscriber?(sender)
      # send a failure message
    else
      # susbcribe the user and send a welcome message
    end
  end
end
</code></pre>

<p>This method is mainly meant to be used with pre-packaged extensions or
more complicated forms of callback helpers. This example was just shown
for the sake of its simplicity, but for similar use cases it would
actually be better to use <code>Newman::Application#helpers</code></p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    
    <span class="k">def</span> <span class="nf">use</span><span class="p">(</span><span class="n">extension</span><span class="p">)</span>
      <span class="n">extensions</span> <span class="o">&lt;&lt;</span> <span class="n">extension</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre>    </pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p><code>Newman::Application#helpers</code> is used to build simple controller
extensions, and is mostly just syntactic sugar. For example, 
rather than using an explicit
module, the example shown in the <code>Newman::Application#use</code> documentation
can be rewritten as follows:</p>

<pre><code>list_app = Newman::Application.new do
  helpers do
    def load_list(name)
      store = Newman::Store.new(settings.application.list_db)
      Newman::MailingList.new(name, store)
    end
  end

  match :list_id, &ldquo;[^.]+&rdquo;

  to(:tag, &ldquo;{list_id}.subscribe&rdquo;) do
    list = load_list(params[:list_id])

    if list.subscriber?(sender)
      # send a failure message
    else
      # susbcribe the user and send a welcome message
    end
  end
end
</code></pre>

<p>It&rsquo;s important to note that for any controller extensions that might be
reusable, or for more complicated logic, <code>Newman::Application#use</code> is
probably a better tool to use.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">helpers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="n">use</span> <span class="no">Module</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre>    </pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>TODO</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
      <span class="n">matchers</span><span class="o">[</span><span class="nb">id</span><span class="o">.</span><span class="n">to_s</span><span class="o">]</span> <span class="o">=</span> <span class="n">pattern</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre>    </pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>TODO</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">filter</span><span class="p">)</span>
      <span class="n">callbacks</span> <span class="o">&lt;&lt;</span> <span class="p">{</span> <span class="ss">:filter</span>   <span class="o">=&gt;</span> <span class="n">filter</span><span class="p">,</span> 
                     <span class="ss">:action</span>   <span class="o">=&gt;</span> <span class="n">action</span> <span class="p">}</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre>    </pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>TODO</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">compile_regex</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
      <span class="no">Regexp</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\\{(.*?)\\}/</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span> <span class="s2">&quot;(?&lt;</span><span class="si">#{</span><span class="vg">$1</span><span class="si">}</span><span class="s2">&gt;</span><span class="si">#{</span><span class="n">matchers</span><span class="o">[</span><span class="vg">$1</span><span class="o">]</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="p">}</span> 
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre>    </pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>TODO</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kp">private</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre>    </pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>TODO</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">trigger_callbacks</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
      <span class="n">matched_callbacks</span> <span class="o">=</span> <span class="n">callbacks</span><span class="o">.</span><span class="n">select</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> 
        <span class="n">filter</span> <span class="o">=</span> <span class="n">e</span><span class="o">[</span><span class="ss">:filter</span><span class="o">]</span>
        <span class="n">e</span><span class="o">[</span><span class="ss">:match_data</span><span class="o">]</span> <span class="o">=</span> <span class="n">filter</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">if</span> <span class="n">matched_callbacks</span><span class="o">.</span><span class="n">empty?</span>
        <span class="n">controller</span><span class="o">.</span><span class="n">instance_exec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">default_callback</span><span class="p">)</span> 
      <span class="k">else</span>
        <span class="n">matched_callbacks</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
          <span class="n">action</span> <span class="o">=</span> <span class="n">e</span><span class="o">[</span><span class="ss">:action</span><span class="o">]</span>
          <span class="n">controller</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">e</span><span class="o">[</span><span class="ss">:match_data</span><span class="o">]</span> <span class="o">||</span> <span class="p">{}</span>
          <span class="n">controller</span><span class="o">.</span><span class="n">instance_exec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">action</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre>    </pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p>TODO</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kp">attr_accessor</span> <span class="ss">:callbacks</span><span class="p">,</span> <span class="ss">:default_callback</span><span class="p">,</span> <span class="ss">:matchers</span><span class="p">,</span> <span class="ss">:extensions</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
