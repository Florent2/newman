<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>controller.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="../newman.html">newman.rb</a>
          <a class="source" href="application.html">application.rb</a>
          <a class="source" href="controller.html">controller.rb</a>
          <a class="source" href="email_logger.html">email_logger.rb</a>
          <a class="source" href="filters.html">filters.rb</a>
          <a class="source" href="mailer.html">mailer.rb</a>
          <a class="source" href="mailing_list.html">mailing_list.rb</a>
          <a class="source" href="recorder.html">recorder.rb</a>
          <a class="source" href="request_logger.html">request_logger.rb</a>
          <a class="source" href="response_logger.html">response_logger.rb</a>
          <a class="source" href="server.html">server.rb</a>
          <a class="source" href="settings.html">settings.rb</a>
          <a class="source" href="store.html">store.rb</a>
          <a class="source" href="test_mailer.html">test_mailer.rb</a>
          <a class="source" href="version.html">version.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>controller.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p><code>Newman::Controller</code> provides a context for application callbacks to run in,
and provides most of the core functionality for preparing a response email.</p>

<p>For a full example of <code>Newman::Controller</code> in action, be sure to check out
<a href="https://github.com/mendicant-university/jester">Jester</a>.</p>

<p><code>Newman::Controller</code> is part of Newman&rsquo;s <strong>external interface</strong>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">module</span> <span class="nn">Newman</span>
  <span class="k">class</span> <span class="nc">Controller</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre>    </pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>A <code>Newman::Controller</code> object is initialized with parameters that match
what is provided by the low level <code>Newman::Server</code> object. Generally
speaking, you won&rsquo;t instantiate controller objects yourself, but instead
will rely on <code>Newman::Application</code> to instantiate them for you.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:settings</span><span class="p">)</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">request</span>  <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:request</span><span class="p">)</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:response</span><span class="p">)</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">logger</span>   <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:logger</span><span class="p">)</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>All of the fields on <code>Newman::Controller</code> are public, so that they can
freely be manipulated by callbacks. We may lock this down a bit more
in a future version of Newman once we figure out what data actually needs
to be exposed in callbacks, but for now you can feel free to depend on
any of these fields.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre> 
    <span class="kp">attr_accessor</span> <span class="ss">:settings</span><span class="p">,</span> <span class="ss">:request</span><span class="p">,</span> <span class="ss">:response</span><span class="p">,</span> <span class="ss">:logger</span><span class="p">,</span> <span class="ss">:params</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre>    </pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p><code>Newman::Controller#respond</code> is used to modify the response email object,
and is used in the manner shown below:</p>

<pre><code>respond :subject =&gt; &ldquo;Hello There&rdquo;, 
        :body    =&gt; &ldquo;It&rsquo;s nice to meet you, pal!&rdquo;
</code></pre>

<p>Because this method simply provides syntactic sugar on top of the
<code>Mail::Message</code> object&rsquo;s interface, you should be sure to take a look at
the documentation for the <a href="http://github.com/mikel/mail">mail gem</a> to
discover what options are available.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">respond</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="n">params</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">response</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">=&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre>    </pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p><code>Newman::Controller#template</code> is used to invoke a template file within the
context of the current controller object using Tilt. A name for the template is
provided and then looked up in the directory referenced by
<code>settings.service.templates_dir</code>. While an example of using templates is 
included in Newman&rsquo;s source, this feature hasn&rsquo;t really been tested 
adequately. Please report any problems with this method in our 
<a href="https://github.com/mendicant-university/newman/issues">issue tracker</a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">template</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
      <span class="no">Tilt</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">settings</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">templates_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">.*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
          <span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p><code>Newman::Controller#skip_response</code> is used for disabling the delivery of
the response email. Use this for situations where no response is required,
such as when a spam email or a bounce has been detected, or if you are
building an application which simply passively monitors incoming email
rather than replying to it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">skip_response</span>
      <span class="n">response</span><span class="o">.</span><span class="n">perform_deliveries</span> <span class="o">=</span> <span class="kp">false</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre>    </pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p><code>Newman::Controller#forward_message</code> works in a similar fashion to
<code>Newman::Controller#response</code>, but copies the request FROM, SUBJECT
and BODY fields and sets the REPLY TO field to be equal to
<code>settings.service.default_sender</code>. This feature is convenient for
implementing mailing-list style functionality, such as in the example
below:</p>

<pre><code>if list.subscriber?(sender)
  forward_message :bcc =&gt; list.subscribers.join(&ldquo;, &rdquo;)
else
  respond :subject =&gt; &ldquo;You are not subscribed&rdquo;,
          :body    =&gt; template(&ldquo;non-subscriber-error&rdquo;)
end
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">forward_message</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">{})</span>
      <span class="n">response</span><span class="o">.</span><span class="n">from</span>      <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">from</span>
      <span class="n">response</span><span class="o">.</span><span class="n">reply_to</span>  <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">default_sender</span> 
      <span class="n">response</span><span class="o">.</span><span class="n">subject</span>   <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">subject</span>

      <span class="n">params</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span>
        <span class="n">response</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">=&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">multipart?</span>
        <span class="n">response</span><span class="o">.</span><span class="n">text_part</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">text_part</span>
        <span class="n">response</span><span class="o">.</span><span class="n">html_part</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">html_part</span>
      <span class="k">else</span>
        <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">to_s</span>
      <span class="k">end</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre>    </pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p><code>Newman::Controller#sender</code> is used as a convenient shortcut for
retrieving the sender&rsquo;s email address from the request object.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">sender</span>
      <span class="n">request</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">to_s</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre>    </pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p><code>Newman::Controller#domain</code> is used as a convenient shortcut for
referencing <code>settings.service.domain</code>.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">domain</span>
      <span class="n">settings</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">domain</span> 
    <span class="k">end</span>


  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
